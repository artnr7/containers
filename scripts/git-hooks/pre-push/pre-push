#!/bin/bash

# --- Конфигурация ---
BUILD_DIR="build"
CMAKE_OPTS="-DCMAKE_BUILD_TYPE=Debug"
THREADS=$(nproc)

# --- Цвета для вывода ---
RED='\033[0;31m'
GREEN='\033[0;32m'
NC='\033[0m' # No Color

# --- Функция для вывода ошибок ---
fail() {
    echo -e "${RED}$1${NC}"
    exit 1
}

# --- Основной скрипт ---
echo -e "\n${GREEN}=== Running pre-push checks ===${NC}"

# 1. Сборка проекта
echo -e "\n${GREEN}[1/3] Building project...${NC}"
mkdir -p "$BUILD_DIR" && cd "$BUILD_DIR" || fail "Cannot create/enter build directory"
cmake $CMAKE_OPTS .. || fail "CMake configuration failed"
cmake --build . --parallel $THREADS || fail "Build failed"
cd ..

# 2. Запуск статических анализаторов
echo -e "\n${GREEN}[2/3] Running static analysis...${NC}"
cd "$BUILD_DIR" || fail "Cannot enter build directory"

echo "> Running clang-format check..."
cmake --build . --target clang-format-test || fail "clang-format check failed"

echo "> Running cppcheck..."
cmake --build . --target cppcheck-test || fail "cppcheck failed"

# --- Успешное завершение ---
echo -e "\n${GREEN}✓ All checks passed! You can push now.${NC}"
exit 0
